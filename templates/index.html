<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Todo Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body
    class="bg-gray-900 text-white min-h-screen flex items-center justify-center p-4"
  >
    <div
      class="w-full max-w-sm bg-white/10 backdrop-blur-lg border border-white/20 rounded-2xl shadow-lg p-6"
    >
      <!-- Welcome -->
      <div id="welcome" class="hidden flex flex-col items-center space-y-4">
        <h1 class="text-2xl font-bold">
          Welcome, <span id="user-name"></span>!
        </h1>
        <p>This is your home page.</p>
        <a
          href="/tasks/"
          class="w-full py-2 bg-white text-black rounded-lg text-center hover:bg-white/80 transition"
        >
          View Dashboard
        </a>
        <button
          id="btn-logout"
          class="w-full py-2 border border-white rounded-lg hover:bg-white/20 transition"
        >
          Log out
        </button>
      </div>

      <!-- Auth Forms -->
      <div id="auth-forms">
        <h1 class="text-2xl font-semibold text-center mb-4">Todo Manager</h1>
        <ul id="messages" class="mb-4 text-sm text-red-400"></ul>

        <!-- Login -->
        <div id="login-form" class="space-y-4">
          <form id="form-login" class="space-y-4">
            <div>
              <label class="block mb-1">Username</label>
              <input
                name="username"
                required
                placeholder="Your username"
                class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg focus:ring-2 focus:ring-white transition"
              />
            </div>
            <div>
              <label class="block mb-1">Password</label>
              <input
                name="password"
                type="password"
                required
                placeholder="••••••"
                class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg focus:ring-2 focus:ring-white transition"
              />
            </div>
            <button
              type="submit"
              class="w-full py-2 bg-white text-black rounded-lg hover:bg-white/80 transition"
            >
              Log In
            </button>
          </form>
          <p class="text-center text-sm">
            Don’t have an account?
            <a href="#" id="show-signup" class="underline">Sign Up</a>
          </p>
        </div>

        <!-- Signup -->
        <div id="signup-form" class="hidden space-y-4">
          <form id="form-signup" class="space-y-4">
            <div>
              <label class="block mb-1">Username</label>
              <input
                name="username"
                required
                placeholder="Choose a username"
                class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg focus:ring-2 focus:ring-white transition"
              />
            </div>
            <div>
              <label class="block mb-1">Password</label>
              <input
                name="password"
                type="password"
                required
                placeholder="••••••"
                class="w-full px-3 py-2 bg-white/20 border border-white/30 rounded-lg focus:ring-2 focus:ring-white transition"
              />
            </div>
            <button
              type="submit"
              class="w-full py-2 bg-white text-black rounded-lg hover:bg-white/80 transition"
            >
              Sign Up
            </button>
          </form>
          <p class="text-center text-sm">
            Already have one?
            <a href="#" id="show-login" class="underline">Log In</a>
          </p>
        </div>
      </div>
    </div>

    <script>
      // ─── your existing non-UI code ───────────────────────────────────────
      const msgsEl = document.getElementById("messages");
      const authForms = document.getElementById("auth-forms");
      const welcomeEl = document.getElementById("welcome");
      const userNameEl = document.getElementById("user-name");

      const loginFormContainer = document.getElementById("login-form");
      const signupFormContainer = document.getElementById("signup-form");
      const showSignupLink = document.getElementById("show-signup");
      const showLoginLink = document.getElementById("show-login");

      function showMsg(text, cls = "error") {
        msgsEl.innerHTML = `<li class="${cls}">${text}</li>`;
      }
      function clearMsgs() {
        msgsEl.innerHTML = "";
      }

      function render() {
        const token = localStorage.getItem("access");
        if (!token) {
          welcomeEl.classList.add("hidden");
          authForms.classList.remove("hidden");
          loginFormContainer.classList.remove("hidden");
          signupFormContainer.classList.add("hidden");
          clearMsgs();
          return;
        }
        const payload = JSON.parse(atob(token.split(".")[1]));
        userNameEl.textContent = payload.username;
        authForms.classList.add("hidden");
        welcomeEl.classList.remove("hidden");
      }

      // ─── API calls ────────────────────────────────────────────────────────
      document.getElementById("form-signup").onsubmit = async (e) => {
        e.preventDefault();
        clearMsgs();
        const data = {
          username: e.target.username.value,
          password: e.target.password.value,
        };
        const res = await fetch("/api/register/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        const body = await res.json();
        if (res.ok) {
          localStorage.setItem("access", body.access);
          localStorage.setItem("refresh", body.refresh);
          render();
        } else {
          showMsg(body.detail || JSON.stringify(body));
        }
      };

      document.getElementById("form-login").onsubmit = async (e) => {
        e.preventDefault();
        clearMsgs();
        const data = {
          username: e.target.username.value,
          password: e.target.password.value,
        };
        const res = await fetch("/api/token/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        const body = await res.json();
        if (res.ok) {
          localStorage.setItem("access", body.access);
          localStorage.setItem("refresh", body.refresh);
          // tell Django to create a session cookie from our JWT
          await fetch("/api/session_login/", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ access: body.access }),
            credentials: "same-origin", // important so the session cookie is sent back
          });

          render();
        } else {
          showMsg(body.detail || JSON.stringify(body));
        }
      };

      document.getElementById("btn-logout").onclick = () => {
        localStorage.removeItem("access");
        localStorage.removeItem("refresh");
        render();
      };
      // ──────────────────────────────────────────────────────────────────────

      // ─── UI toggles for Login / Signup ──────────────────────────────────
      showSignupLink.onclick = (e) => {
        e.preventDefault();
        loginFormContainer.classList.add("hidden");
        signupFormContainer.classList.remove("hidden");
        clearMsgs();
      };
      showLoginLink.onclick = (e) => {
        e.preventDefault();
        signupFormContainer.classList.add("hidden");
        loginFormContainer.classList.remove("hidden");
        clearMsgs();
      };
      // ──────────────────────────────────────────────────────────────────────

      // initial display
      render();
    </script>
  </body>
</html>
